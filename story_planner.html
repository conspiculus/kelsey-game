<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Story Planner — Decision Tree Worksheet</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #c9a84c;
    --gold-dim: rgba(201,168,76,0.2);
    --gold-glow: rgba(201,168,76,0.08);
    --red: #b43c3c;
    --red-dim: rgba(180,60,60,0.15);
    --green: #5b8a72;
    --green-dim: rgba(91,138,114,0.1);
    --bg: #0a0a0f;
    --bg-card: #0f0f18;
    --text: #e8dcc8;
    --text-dim: #8a7e6b;
    --text-mid: #c4b89a;
    --border: rgba(201,168,76,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Crimson Text', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 20px 80px;
  }

  h1 {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: clamp(1.4rem, 4vw, 2.2rem);
    text-align: center;
    color: var(--gold);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 4px;
    text-shadow: 0 0 30px rgba(201,168,76,0.3);
  }

  .subtitle {
    text-align: center;
    font-size: 1rem;
    color: var(--text-dim);
    font-style: italic;
    margin-bottom: 16px;
  }

  /* User panel */
  .user-panel {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 24px;
    padding: 10px 16px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 8px;
  }

  .user-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.82rem;
    color: var(--text-mid);
    padding: 4px 10px;
    border-radius: 20px;
    background: rgba(255,255,255,0.03);
  }

  .user-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Mini tree */
  .tree-wrap {
    position: relative;
    overflow-x: auto;
    margin-bottom: 40px;
    padding-bottom: 8px;
  }

  svg.tree { display: block; margin: 0 auto; }

  /* Turn dividers */
  .turn-section {
    margin-bottom: 48px;
    position: relative;
  }

  .turn-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 20px;
  }

  .turn-badge {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--bg);
    background: var(--gold);
    padding: 4px 14px;
    border-radius: 4px;
    white-space: nowrap;
  }

  .turn-badge.ending {
    background: var(--red);
    color: #fbe8e0;
  }

  .turn-line {
    flex: 1;
    height: 1px;
    background: var(--gold-dim);
  }

  .turn-desc {
    font-size: 0.88rem;
    color: var(--text-dim);
    font-style: italic;
    white-space: nowrap;
  }

  /* Animation cards */
  .anim-grid {
    display: grid;
    gap: 20px;
  }

  .anim-grid.cols-1 { grid-template-columns: 1fr; }
  .anim-grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .anim-grid.cols-4 { grid-template-columns: 1fr 1fr; }

  @media (min-width: 700px) {
    .anim-grid.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
  }

  .anim-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    position: relative;
    transition: border-color 0.3s;
  }

  .anim-card:focus-within {
    border-color: rgba(201,168,76,0.4);
    box-shadow: 0 0 20px rgba(201,168,76,0.06);
  }

  .anim-card::before {
    content: '';
    position: absolute;
    top: 0; left: 20px; right: 20px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
  }

  .anim-card.ending-card {
    border-color: var(--red-dim);
  }

  .anim-card.ending-card:focus-within {
    border-color: rgba(180,60,60,0.4);
    box-shadow: 0 0 20px rgba(180,60,60,0.08);
  }

  .anim-card.ending-card::before {
    background: linear-gradient(90deg, transparent, var(--red-dim), transparent);
  }

  .card-label {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }

  .card-number {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 1.1rem;
    color: var(--gold);
    background: var(--gold-glow);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--gold-dim);
    flex-shrink: 0;
  }

  .card-number.ending-num {
    color: var(--red);
    background: var(--red-dim);
    border-color: rgba(180,60,60,0.3);
    width: auto;
    border-radius: 4px;
    padding: 0 10px;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
  }

  .card-path {
    font-size: 0.78rem;
    color: var(--text-dim);
    font-style: italic;
    letter-spacing: 0.02em;
  }

  .field-group {
    margin-bottom: 14px;
  }

  .field-group:last-child {
    margin-bottom: 0;
  }

  .field-label {
    font-family: 'Cinzel', serif;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 6px;
    display: block;
  }

  .field-label.choice-label {
    color: var(--green);
  }

  .field-label.ending-label {
    color: var(--red);
  }

  /* Collaborative editor fields */
  .collab-editor {
    width: 100%;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Crimson Text', Georgia, serif;
    font-size: 0.95rem;
    line-height: 1.55;
    padding: 10px 12px;
    min-height: 44px;
    transition: border-color 0.3s, background 0.3s;
    outline: none;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .collab-editor:focus {
    border-color: rgba(201,168,76,0.35);
    background: rgba(255,255,255,0.05);
  }

  .collab-editor.story-field {
    min-height: 80px;
  }

  .collab-editor.story-field-lg {
    min-height: 110px;
  }

  .collab-editor.choice-field {
    border-color: rgba(91,138,114,0.2);
    min-height: 44px;
  }

  .collab-editor.choice-field:focus {
    border-color: rgba(91,138,114,0.45);
  }

  .ending-card .collab-editor:focus {
    border-color: rgba(180,60,60,0.35);
  }

  .collab-editor:empty::before {
    content: attr(data-placeholder);
    color: rgba(138,126,107,0.4);
    font-style: italic;
    pointer-events: none;
  }

  /* Segment spans inside editors */
  .collab-editor .seg {
    border-radius: 2px;
  }

  .collab-editor .seg-other {
    cursor: default;
    opacity: 0.95;
  }

  .collab-editor .seg-mine {
    outline: none;
  }

  .collab-editor .seg-gap {
    outline: none;
    min-width: 2px;
    display: inline;
  }

  .choice-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .choice-box {
    position: relative;
  }

  .choice-arrow {
    font-size: 0.72rem;
    color: var(--green);
    margin-top: 4px;
    font-style: italic;
    opacity: 0.7;
  }

  .merge-note {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    color: var(--green);
    font-style: italic;
    margin-top: 6px;
    padding: 3px 8px;
    background: var(--green-dim);
    border-radius: 4px;
  }

  .merge-dot {
    width: 8px;
    height: 8px;
    border: 1.5px dashed var(--green);
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Save bar */
  .save-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, var(--bg) 30%);
    padding: 30px 20px 20px;
    display: flex;
    justify-content: center;
    gap: 12px;
    z-index: 100;
  }

  .btn {
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: 0.78rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 10px 24px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-gold {
    background: var(--gold);
    color: var(--bg);
  }

  .btn-gold:hover {
    background: #d4b55a;
    box-shadow: 0 0 20px rgba(201,168,76,0.3);
  }

  .btn-outline {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--border);
  }

  .btn-outline:hover {
    border-color: var(--gold-dim);
    color: var(--text);
  }

  .toast {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: rgba(91,138,114,0.9);
    color: #fff;
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 0.85rem;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 101;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .toast.error {
    background: rgba(180,60,60,0.9);
  }

  /* Registration modal */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.hidden { display: none; }

  .modal {
    background: var(--bg-card);
    border: 1px solid var(--gold-dim);
    border-radius: 14px;
    padding: 32px 28px;
    max-width: 420px;
    width: 100%;
    text-align: center;
  }

  .modal h2 {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    color: var(--gold);
    font-size: 1.3rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .modal p {
    font-size: 0.95rem;
    color: var(--text-mid);
    line-height: 1.6;
    margin-bottom: 20px;
  }

  .modal-field {
    width: 100%;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Crimson Text', Georgia, serif;
    font-size: 1.1rem;
    padding: 12px 16px;
    margin-bottom: 20px;
    outline: none;
    text-align: center;
  }

  .modal-field:focus {
    border-color: var(--gold);
  }

  .modal-field::placeholder {
    color: rgba(138,126,107,0.5);
    font-style: italic;
  }

  .color-label {
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 12px;
    display: block;
  }

  .color-swatches {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
  }

  .swatch {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .swatch:hover {
    transform: scale(1.1);
  }

  .swatch.selected {
    border-color: #fff;
    box-shadow: 0 0 12px rgba(255,255,255,0.3);
  }

  .modal-btn {
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 14px 40px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: var(--gold);
    color: var(--bg);
    transition: all 0.2s;
    min-height: 48px;
  }

  .modal-btn:hover {
    background: #d4b55a;
    box-shadow: 0 0 20px rgba(201,168,76,0.3);
  }

  .modal-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* Sync indicator */
  .sync-indicator {
    position: fixed;
    top: 12px;
    right: 12px;
    font-size: 0.7rem;
    color: var(--text-dim);
    font-family: 'Cinzel', serif;
    letter-spacing: 0.05em;
    z-index: 50;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .sync-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
  }

  .sync-dot.stale {
    background: var(--red);
  }

  .returning-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 12px 16px;
    min-height: 48px;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Crimson Text', Georgia, serif;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
  }

  .returning-btn:hover {
    border-color: var(--gold-dim);
    background: rgba(255,255,255,0.06);
  }

  .returning-btn .ret-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  @media (max-width: 600px) {
    .anim-grid.cols-2 { grid-template-columns: 1fr; }
    .anim-grid.cols-4 { grid-template-columns: 1fr; }
    .choice-row { grid-template-columns: 1fr; }
    .save-bar { gap: 8px; padding: 20px 12px 16px; }
    .btn { padding: 12px 16px; font-size: 0.72rem; }
    .container { padding: 24px 12px 80px; }
  }
</style>
</head>
<body>

<!-- Password Modal -->
<div class="modal-overlay" id="pwModal">
  <div class="modal">
    <h2>Enter Password</h2>
    <p>This page is invite-only. Enter the password to continue.</p>
    <input type="password" class="modal-field" id="pwInput" placeholder="Password" autocomplete="off">
    <div id="pwError" style="color: var(--red); font-size: 0.85rem; margin-bottom: 12px; display: none;">Wrong password. Try again.</div>
    <button class="modal-btn" id="pwSubmit">Enter</button>
  </div>
</div>

<!-- Registration Modal -->
<div class="modal-overlay hidden" id="regModal">
  <div class="modal">
    <h2>Welcome Friend!</h2>
    <p>I made this to invite everyone to collaborate on an interactive game I'm making for Kelsey's Birthday. It's very simple: short animations with two choices that lead to two possible outcomes, eventually leading to two possible endings. But I want everyone's help to create the story! There are 11 "cards" and 22 "choices". The whole thing does not have to make sense at all, it's meant to be irreverent and funny. For obvious reasons I'm going with a Lord Of The Rings / Fantasy theme here. The story starts with Kelsey in the Castle "Eyrie" starting her journey to the Misty Mountains. Have fun with it — nothing is off limits lol. Your text will appear in the color you pick below, and you can't delete anyone else's writing.</p>

    <!-- Returning user list (populated dynamically) -->
    <div id="returningSection" style="display: none;">
      <label class="color-label" style="margin-bottom: 10px;">Returning? Pick your name:</label>
      <div id="returningList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;"></div>
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="flex: 1; height: 1px; background: var(--border);"></div>
        <span style="font-size: 0.78rem; color: var(--text-dim); font-style: italic; white-space: nowrap;">Or join as a new collaborator</span>
        <div style="flex: 1; height: 1px; background: var(--border);"></div>
      </div>
    </div>

    <input type="text" class="modal-field" id="regName" placeholder="Enter your name" maxlength="30" autocomplete="off">
    <label class="color-label">Pick Your Color</label>
    <div class="color-swatches" id="colorSwatches"></div>
    <button class="modal-btn" id="regSubmit" disabled>Join</button>
  </div>
</div>

<!-- Sync indicator -->
<div class="sync-indicator">
  <div class="sync-dot" id="syncDot"></div>
  <span id="syncLabel">Connected</span>
</div>

<div class="container">
  <h1>Story Planner</h1>
  <p class="subtitle">11 animations · 5 turns · 2 endings — collaborate on your story below</p>

  <!-- User panel -->
  <div class="user-panel" id="userPanel"></div>

  <!-- Mini decision tree for reference -->
  <div class="tree-wrap">
    <svg class="tree" id="treeSvg" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <!-- TURN 1 -->
  <div class="turn-section">
    <div class="turn-header">
      <div class="turn-badge">Turn 1</div>
      <div class="turn-line"></div>
      <div class="turn-desc">1 animation · opening scene</div>
    </div>
    <div class="anim-grid cols-1">
      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">1</div>
          <div class="card-path">Opening — everyone sees this</div>
        </div>
        <div class="field-group">
          <label class="field-label">Animation / Scene Description</label>
          <div class="collab-editor story-field-lg" data-field="a1_story" data-placeholder="Describe the opening scene... What does the player see? What's happening in the story?"></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a1_choiceA" data-placeholder="Choice A → Anim 2"></div>
              <div class="choice-arrow">→ leads to Animation 2</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a1_choiceB" data-placeholder="Choice B → Anim 3"></div>
              <div class="choice-arrow">→ leads to Animation 3</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TURN 2 -->
  <div class="turn-section">
    <div class="turn-header">
      <div class="turn-badge">Turn 2</div>
      <div class="turn-line"></div>
      <div class="turn-desc">2 animations · paths diverge</div>
    </div>
    <div class="anim-grid cols-2">
      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">2</div>
          <div class="card-path">From: Choice A at Anim 1</div>
        </div>
        <div class="field-group">
          <label class="field-label">Animation / Scene Description</label>
          <div class="collab-editor story-field" data-field="a2_story" data-placeholder="What happens on this path?"></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a2_choiceA" data-placeholder="Choice A → Anim 4"></div>
              <div class="choice-arrow">→ leads to Animation 4</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a2_choiceB" data-placeholder="Choice B → Anim 5"></div>
              <div class="choice-arrow">→ leads to Animation 5</div>
            </div>
          </div>
        </div>
      </div>

      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">3</div>
          <div class="card-path">From: Choice B at Anim 1</div>
        </div>
        <div class="field-group">
          <label class="field-label">Animation / Scene Description</label>
          <div class="collab-editor story-field" data-field="a3_story" data-placeholder="What happens on this path?"></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a3_choiceA" data-placeholder="Choice A → Anim 6"></div>
              <div class="choice-arrow">→ leads to Animation 6</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a3_choiceB" data-placeholder="Choice B → Anim 7"></div>
              <div class="choice-arrow">→ leads to Animation 7</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TURN 3 — peak width -->
  <div class="turn-section">
    <div class="turn-header">
      <div class="turn-badge">Turn 3</div>
      <div class="turn-line"></div>
      <div class="turn-desc">4 animations · peak width, then merge</div>
    </div>
    <div class="anim-grid cols-4">
      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">4</div>
          <div class="card-path">From: A2 → Choice A</div>
        </div>
        <div class="field-group">
          <label class="field-label">Scene Description</label>
          <div class="collab-editor story-field" data-field="a4_story" data-placeholder="Scene 4..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a4_choiceA" data-placeholder="Choice A → Anim 8"></div>
              <div class="choice-arrow">→ Anim 8</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a4_choiceB" data-placeholder="Choice B → Anim 9"></div>
              <div class="choice-arrow">→ Anim 9</div>
            </div>
          </div>
          <div class="merge-note"><div class="merge-dot"></div>Merges into shared Anim 8 or 9</div>
        </div>
      </div>

      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">5</div>
          <div class="card-path">From: A2 → Choice B</div>
        </div>
        <div class="field-group">
          <label class="field-label">Scene Description</label>
          <div class="collab-editor story-field" data-field="a5_story" data-placeholder="Scene 5..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a5_choiceA" data-placeholder="Choice A → Anim 8"></div>
              <div class="choice-arrow">→ Anim 8</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a5_choiceB" data-placeholder="Choice B → Anim 9"></div>
              <div class="choice-arrow">→ Anim 9</div>
            </div>
          </div>
          <div class="merge-note"><div class="merge-dot"></div>Merges into shared Anim 8 or 9</div>
        </div>
      </div>

      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">6</div>
          <div class="card-path">From: A3 → Choice A</div>
        </div>
        <div class="field-group">
          <label class="field-label">Scene Description</label>
          <div class="collab-editor story-field" data-field="a6_story" data-placeholder="Scene 6..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a6_choiceA" data-placeholder="Choice A → Anim 8"></div>
              <div class="choice-arrow">→ Anim 8</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a6_choiceB" data-placeholder="Choice B → Anim 9"></div>
              <div class="choice-arrow">→ Anim 9</div>
            </div>
          </div>
          <div class="merge-note"><div class="merge-dot"></div>Merges into shared Anim 8 or 9</div>
        </div>
      </div>

      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">7</div>
          <div class="card-path">From: A3 → Choice B</div>
        </div>
        <div class="field-group">
          <label class="field-label">Scene Description</label>
          <div class="collab-editor story-field" data-field="a7_story" data-placeholder="Scene 7..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a7_choiceA" data-placeholder="Choice A → Anim 8"></div>
              <div class="choice-arrow">→ Anim 8</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a7_choiceB" data-placeholder="Choice B → Anim 9"></div>
              <div class="choice-arrow">→ Anim 9</div>
            </div>
          </div>
          <div class="merge-note"><div class="merge-dot"></div>Merges into shared Anim 8 or 9</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TURN 4 — merged -->
  <div class="turn-section">
    <div class="turn-header">
      <div class="turn-badge">Turn 4</div>
      <div class="turn-line"></div>
      <div class="turn-desc">2 animations · paths have converged</div>
    </div>
    <div class="anim-grid cols-2">
      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">8</div>
          <div class="card-path">Merged path — multiple routes lead here</div>
        </div>
        <div class="field-group">
          <label class="field-label">Animation / Scene Description</label>
          <div class="collab-editor story-field" data-field="a8_story" data-placeholder="This scene needs to work regardless of which earlier path the player took..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a8_choiceA" data-placeholder="Choice A → Anim 10"></div>
              <div class="choice-arrow">→ leads to Animation 10</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a8_choiceB" data-placeholder="Choice B → Anim 11"></div>
              <div class="choice-arrow">→ leads to Animation 11</div>
            </div>
          </div>
        </div>
      </div>

      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">9</div>
          <div class="card-path">Merged path — multiple routes lead here</div>
        </div>
        <div class="field-group">
          <label class="field-label">Animation / Scene Description</label>
          <div class="collab-editor story-field" data-field="a9_story" data-placeholder="This scene needs to work regardless of which earlier path the player took..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Player Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a9_choiceA" data-placeholder="Choice A → Anim 10"></div>
              <div class="choice-arrow">→ leads to Animation 10</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a9_choiceB" data-placeholder="Choice B → Anim 11"></div>
              <div class="choice-arrow">→ leads to Animation 11</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TURN 5 — final -->
  <div class="turn-section">
    <div class="turn-header">
      <div class="turn-badge">Turn 5</div>
      <div class="turn-line"></div>
      <div class="turn-desc">2 animations · final choice determines ending</div>
    </div>
    <div class="anim-grid cols-2">
      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">10</div>
          <div class="card-path">Penultimate scene — path A</div>
        </div>
        <div class="field-group">
          <label class="field-label">Animation / Scene Description</label>
          <div class="collab-editor story-field" data-field="a10_story" data-placeholder="The lead-up to the final choice..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Final Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a10_choiceA" data-placeholder="Choice A → Ending A"></div>
              <div class="choice-arrow">→ leads to Ending A</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a10_choiceB" data-placeholder="Choice B → Ending B"></div>
              <div class="choice-arrow">→ leads to Ending B</div>
            </div>
          </div>
        </div>
      </div>

      <div class="anim-card">
        <div class="card-label">
          <div class="card-number">11</div>
          <div class="card-path">Penultimate scene — path B</div>
        </div>
        <div class="field-group">
          <label class="field-label">Animation / Scene Description</label>
          <div class="collab-editor story-field" data-field="a11_story" data-placeholder="The lead-up to the final choice..."></div>
        </div>
        <div class="field-group">
          <label class="field-label choice-label">Final Choice</label>
          <div class="choice-row">
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a11_choiceA" data-placeholder="Choice A → Ending A"></div>
              <div class="choice-arrow">→ leads to Ending A</div>
            </div>
            <div class="choice-box">
              <div class="collab-editor choice-field" data-field="a11_choiceB" data-placeholder="Choice B → Ending B"></div>
              <div class="choice-arrow">→ leads to Ending B</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENDINGS -->
  <div class="turn-section">
    <div class="turn-header">
      <div class="turn-badge ending">Endings</div>
      <div class="turn-line" style="background: var(--red-dim);"></div>
      <div class="turn-desc">2 possible endings</div>
    </div>
    <div class="anim-grid cols-2">
      <div class="anim-card ending-card">
        <div class="card-label">
          <div class="card-number ending-num">ENDING A</div>
        </div>
        <div class="field-group">
          <label class="field-label ending-label">Ending Scene Description</label>
          <div class="collab-editor story-field-lg" data-field="endA_story" data-placeholder="How does this ending play out? What's the final moment the player sees?"></div>
        </div>
        <div class="field-group">
          <label class="field-label ending-label">Closing Message</label>
          <div class="collab-editor" data-field="endA_message" data-placeholder="Final text shown to the player..." style="border-color: var(--red-dim);"></div>
        </div>
      </div>

      <div class="anim-card ending-card">
        <div class="card-label">
          <div class="card-number ending-num">ENDING B</div>
        </div>
        <div class="field-group">
          <label class="field-label ending-label">Ending Scene Description</label>
          <div class="collab-editor story-field-lg" data-field="endB_story" data-placeholder="How does this ending play out? What's the final moment the player sees?"></div>
        </div>
        <div class="field-group">
          <label class="field-label ending-label">Closing Message</label>
          <div class="collab-editor" data-field="endB_message" data-placeholder="Final text shown to the player..." style="border-color: var(--red-dim);"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Save bar -->
<div class="save-bar">
  <button class="btn btn-gold" onclick="saveAllFields()">Save Progress</button>
  <button class="btn btn-outline" onclick="exportData()">Export as JSON</button>
</div>

<div class="toast" id="toast"></div>

<!-- Mini tree SVG -->
<script>
(function() {
  const svg = document.getElementById('treeSvg');
  const ns = 'http://www.w3.org/2000/svg';

  const W = 580;
  const levelGap = 52;
  const nodeR = 7;
  const endR = 8;
  const topPad = 24;
  const turnLabelW = 36;
  const totalW = W + turnLabelW + 16;
  const totalH = 6 * levelGap + 46;
  const ox = turnLabelW + 8;

  svg.setAttribute('width', totalW);
  svg.setAttribute('height', totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);

  function nx(f) { return ox + W * f; }
  function ny(t) { return topPad + t * levelGap; }

  const nodes = {
    'T1_1': { x: nx(0.5), y: ny(0) },
    'T2_1': { x: nx(0.25), y: ny(1) },
    'T2_2': { x: nx(0.75), y: ny(1) },
    'T3_1': { x: nx(0.1),  y: ny(2) },
    'T3_2': { x: nx(0.35), y: ny(2) },
    'T3_3': { x: nx(0.65), y: ny(2) },
    'T3_4': { x: nx(0.9),  y: ny(2) },
    'T4_1': { x: nx(0.25), y: ny(3) },
    'T4_2': { x: nx(0.75), y: ny(3) },
    'T5_1': { x: nx(0.25), y: ny(4) },
    'T5_2': { x: nx(0.75), y: ny(4) },
  };

  const endings = {
    'E1': { x: nx(0.25), y: ny(5) + 6 },
    'E2': { x: nx(0.75), y: ny(5) + 6 },
  };

  const edges = [
    ['T1_1','T2_1',false],['T1_1','T2_2',false],
    ['T2_1','T3_1',false],['T2_1','T3_2',false],['T2_2','T3_3',false],['T2_2','T3_4',false],
    ['T3_1','T4_1',false],['T3_1','T4_2',true],['T3_2','T4_1',false],['T3_2','T4_2',true],
    ['T3_3','T4_1',true],['T3_3','T4_2',false],['T3_4','T4_1',true],['T3_4','T4_2',false],
    ['T4_1','T5_1',false],['T4_1','T5_2',true],['T4_2','T5_1',true],['T4_2','T5_2',false],
    ['T5_1','E1',false],['T5_2','E2',false],
  ];

  const eg = document.createElementNS(ns, 'g');
  edges.forEach(([f,t,m]) => {
    const from = nodes[f]||endings[f], to = nodes[t]||endings[t];
    const p = document.createElementNS(ns, 'path');
    const my = (from.y+to.y)/2;
    p.setAttribute('d',`M ${from.x} ${from.y+nodeR} C ${from.x} ${my}, ${to.x} ${my}, ${to.x} ${to.y-nodeR}`);
    p.setAttribute('fill','none');
    if(t.startsWith('E')){p.setAttribute('stroke','rgba(180,60,60,0.3)');p.setAttribute('stroke-width','1.5');}
    else if(m){p.setAttribute('stroke','rgba(91,138,114,0.3)');p.setAttribute('stroke-width','1');p.setAttribute('stroke-dasharray','5 3');}
    else{p.setAttribute('stroke','rgba(201,168,76,0.2)');p.setAttribute('stroke-width','1.3');}
    eg.appendChild(p);
  });
  svg.appendChild(eg);

  const ng = document.createElementNS(ns, 'g');
  const animNums = {'T1_1':'1','T2_1':'2','T2_2':'3','T3_1':'4','T3_2':'5','T3_3':'6','T3_4':'7','T4_1':'8','T4_2':'9','T5_1':'10','T5_2':'11'};

  Object.entries(nodes).forEach(([id,n]) => {
    const c = document.createElementNS(ns,'circle');
    c.setAttribute('cx',n.x);c.setAttribute('cy',n.y);c.setAttribute('r',nodeR);c.setAttribute('fill','#c9a84c');
    ng.appendChild(c);
    const l = document.createElementNS(ns,'text');
    l.setAttribute('x',n.x);l.setAttribute('y',n.y+2.5);l.setAttribute('text-anchor','middle');
    l.setAttribute('fill','#0a0a0f');l.setAttribute('font-family','Cinzel,serif');l.setAttribute('font-size','6');l.setAttribute('font-weight','900');
    l.textContent=animNums[id]||'';ng.appendChild(l);
  });

  Object.entries(endings).forEach(([id,e]) => {
    const c = document.createElementNS(ns,'circle');
    c.setAttribute('cx',e.x);c.setAttribute('cy',e.y);c.setAttribute('r',endR);c.setAttribute('fill','#b43c3c');
    ng.appendChild(c);
    const l = document.createElementNS(ns,'text');
    l.setAttribute('x',e.x);l.setAttribute('y',e.y+endR+13);l.setAttribute('text-anchor','middle');
    l.setAttribute('fill','#b43c3c');l.setAttribute('font-family','Cinzel,serif');l.setAttribute('font-size','8');l.setAttribute('font-weight','700');
    l.textContent=id==='E1'?'END A':'END B';ng.appendChild(l);
  });
  svg.appendChild(ng);

  const lg = document.createElementNS(ns,'g');
  [1,2,4,2,2].forEach((cnt,i) => {
    const y=ny(i);
    const t=document.createElementNS(ns,'text');
    t.setAttribute('x',4);t.setAttribute('y',y+3);t.setAttribute('fill','#c9a84c');
    t.setAttribute('font-family','Cinzel,serif');t.setAttribute('font-size','9');t.setAttribute('font-weight','700');
    t.textContent=`T${i+1}`;lg.appendChild(t);
  });
  const el=document.createElementNS(ns,'text');
  el.setAttribute('x',4);el.setAttribute('y',ny(5)+10);el.setAttribute('fill','#b43c3c');
  el.setAttribute('font-family','Cinzel,serif');el.setAttribute('font-size','9');el.setAttribute('font-weight','700');
  el.textContent='END';lg.appendChild(el);
  svg.appendChild(lg);

  const ml=document.createElementNS(ns,'text');
  ml.setAttribute('x',nx(0.5));ml.setAttribute('y',(ny(2)+ny(3))/2+3);ml.setAttribute('text-anchor','middle');
  ml.setAttribute('fill','#5b8a72');ml.setAttribute('font-family','Crimson Text,serif');ml.setAttribute('font-size','9');ml.setAttribute('font-style','italic');
  ml.textContent='◆ merge';svg.appendChild(ml);
})();
</script>

<!-- Collaborative Editor Logic -->
<script>
(function() {
  // === State ===
  let currentUser = null; // { userId, name, color }
  let serverData = { users: {}, fields: {}, version: 0 };
  let localEdits = {}; // fieldId -> segments (unsaved local state)
  let focusedField = null;
  let pollTimer = null;
  let sitePassword = localStorage.getItem('storyplanner_pw') || '';

  const PRESET_COLORS = [
    '#e06c75', '#61afef', '#98c379', '#d19a66',
    '#c678dd', '#56b6c2', '#e5c07b', '#be5046'
  ];

  // === Utility ===
  function showToast(msg, isError) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => t.className = 'toast', 2500);
  }

  function generateId() {
    return 'user_' + Math.random().toString(36).substr(2, 9);
  }

  function authHeaders(extra) {
    return Object.assign({ 'Authorization': 'Bearer ' + sitePassword }, extra || {});
  }

  // === Password Gate ===
  async function initPasswordGate() {
    const pwModal = document.getElementById('pwModal');
    const pwInput = document.getElementById('pwInput');
    const pwSubmit = document.getElementById('pwSubmit');
    const pwError = document.getElementById('pwError');

    // If we already have a stored password, validate it silently
    if (sitePassword) {
      try {
        const resp = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: sitePassword }),
        });
        if (resp.ok) {
          pwModal.classList.add('hidden');
          initRegistration();
          return;
        }
      } catch (e) { /* fall through to show modal */ }
      // Stored password is wrong, clear it
      sitePassword = '';
      localStorage.removeItem('storyplanner_pw');
    }

    // Show password modal
    async function submitPassword() {
      const pw = pwInput.value.trim();
      if (!pw) return;
      pwSubmit.disabled = true;
      try {
        const resp = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pw }),
        });
        if (resp.ok) {
          sitePassword = pw;
          localStorage.setItem('storyplanner_pw', pw);
          pwModal.classList.add('hidden');
          initRegistration();
        } else {
          pwError.style.display = 'block';
          pwInput.value = '';
          pwSubmit.disabled = false;
          pwInput.focus();
        }
      } catch (e) {
        pwError.textContent = 'Connection error. Try again.';
        pwError.style.display = 'block';
        pwSubmit.disabled = false;
      }
    }

    pwSubmit.addEventListener('click', submitPassword);
    pwInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') submitPassword();
    });
  }

  // === Registration Modal ===
  async function initRegistration() {
    const saved = localStorage.getItem('storyplanner_user');
    if (saved) {
      currentUser = JSON.parse(saved);
      registerUserOnServer();
      startApp();
      return;
    }

    // Fetch existing users for the returning user list
    try {
      const resp = await fetch('/api/data', {
        headers: authHeaders(),
      });
      if (resp.ok) {
        const data = await resp.json();
        const userEntries = Object.entries(data.users || {});
        if (userEntries.length > 0) {
          const section = document.getElementById('returningSection');
          const list = document.getElementById('returningList');
          section.style.display = 'block';
          list.innerHTML = '';
          userEntries.forEach(([uid, info]) => {
            const btn = document.createElement('button');
            btn.className = 'returning-btn';
            btn.innerHTML = '<div class="ret-dot" style="background:' + info.color + '"></div>' + info.name;
            btn.addEventListener('click', () => {
              currentUser = { userId: uid, name: info.name, color: info.color };
              localStorage.setItem('storyplanner_user', JSON.stringify(currentUser));
              document.getElementById('regModal').classList.add('hidden');
              startApp();
            });
            list.appendChild(btn);
          });
        }
      }
    } catch (e) { /* no returning users, that's fine */ }

    // Show registration modal
    document.getElementById('regModal').classList.remove('hidden');

    const swatchContainer = document.getElementById('colorSwatches');
    let selectedColor = null;

    PRESET_COLORS.forEach(color => {
      const s = document.createElement('div');
      s.className = 'swatch';
      s.style.background = color;
      s.addEventListener('click', () => {
        document.querySelectorAll('.swatch').forEach(sw => sw.classList.remove('selected'));
        s.classList.add('selected');
        selectedColor = color;
        updateJoinBtn();
      });
      swatchContainer.appendChild(s);
    });

    const nameInput = document.getElementById('regName');
    const joinBtn = document.getElementById('regSubmit');

    function updateJoinBtn() {
      joinBtn.disabled = !nameInput.value.trim() || !selectedColor;
    }

    nameInput.addEventListener('input', updateJoinBtn);

    joinBtn.addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (!name || !selectedColor) return;

      currentUser = {
        userId: generateId(),
        name: name,
        color: selectedColor,
      };
      localStorage.setItem('storyplanner_user', JSON.stringify(currentUser));
      document.getElementById('regModal').classList.add('hidden');
      registerUserOnServer();
      startApp();
    });
  }

  async function registerUserOnServer() {
    try {
      await fetch('/api/users', {
        method: 'POST',
        headers: authHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify(currentUser),
      });
    } catch (e) { /* silently fail, will retry on next save */ }
  }

  // === User Panel ===
  function renderUserPanel() {
    const panel = document.getElementById('userPanel');
    panel.innerHTML = '';
    for (const [uid, info] of Object.entries(serverData.users)) {
      const chip = document.createElement('div');
      chip.className = 'user-chip';
      const dot = document.createElement('div');
      dot.className = 'user-dot';
      dot.style.background = info.color;
      const label = document.createElement('span');
      label.textContent = info.name;
      if (currentUser && uid === currentUser.userId) {
        label.textContent += ' (you)';
      }
      chip.appendChild(dot);
      chip.appendChild(label);
      panel.appendChild(chip);
    }
  }

  // === Collaborative Editors ===

  function getEditorSegments(editor) {
    const segments = [];
    const spans = editor.querySelectorAll('.seg, .seg-gap');
    spans.forEach(span => {
      const uid = span.dataset.userId;
      const text = span.textContent;
      if (text.length > 0 && uid) {
        // Merge consecutive segments from same user
        if (segments.length > 0 && segments[segments.length - 1].userId === uid) {
          segments[segments.length - 1].text += text;
        } else {
          segments.push({ userId: uid, text });
        }
      }
    });
    return segments;
  }

  function renderEditor(editor, segments, forceRender) {
    const fieldId = editor.dataset.field;
    const isFocused = document.activeElement === editor || editor.contains(document.activeElement);

    // Don't re-render focused editors unless forced
    if (isFocused && !forceRender) return;

    // Save and restore cursor position by character offset
    editor.innerHTML = '';

    if (!segments || segments.length === 0) {
      // Empty field: single editable gap
      const gap = createGap();
      editor.appendChild(gap);
      editor.setAttribute('contenteditable', 'true');
      return;
    }

    editor.setAttribute('contenteditable', 'true');

    // Leading gap for current user to type before first segment
    if (segments[0].userId !== (currentUser && currentUser.userId)) {
      editor.appendChild(createGap());
    }

    segments.forEach((seg, i) => {
      const span = document.createElement('span');
      const isMine = currentUser && seg.userId === currentUser.userId;

      span.className = isMine ? 'seg seg-mine' : 'seg seg-other';
      span.dataset.userId = seg.userId;
      span.textContent = seg.text;

      const userInfo = serverData.users[seg.userId];
      if (userInfo) {
        span.style.color = userInfo.color;
      }

      if (!isMine) {
        span.setAttribute('contenteditable', 'false');
      }

      editor.appendChild(span);

      // Insert gap after other-user segments so current user can type between them
      const nextSeg = segments[i + 1];
      if (!isMine && nextSeg && nextSeg.userId !== (currentUser && currentUser.userId)) {
        editor.appendChild(createGap());
      } else if (!isMine && !nextSeg) {
        // Trailing gap after last other-user segment
        editor.appendChild(createGap());
      }
    });
  }

  function createGap() {
    const gap = document.createElement('span');
    gap.className = 'seg seg-gap';
    gap.dataset.userId = currentUser ? currentUser.userId : '';
    gap.style.color = currentUser ? currentUser.color : 'inherit';
    // Use zero-width space to make the gap focusable/clickable
    gap.textContent = '';
    return gap;
  }

  function setupEditor(editor) {
    // Handle input: mark new text with current user's color
    editor.addEventListener('beforeinput', (e) => {
      if (!currentUser) {
        e.preventDefault();
        return;
      }

      const sel = window.getSelection();
      if (!sel.rangeCount) return;

      // Block delete/backspace that would cross into other-user spans
      if (e.inputType === 'deleteContentBackward' || e.inputType === 'deleteContentForward' ||
          e.inputType === 'deleteByCut' || e.inputType === 'deleteByDrag') {
        const range = sel.getRangeAt(0);
        if (!range.collapsed) {
          // Check if selection contains other-user content
          const contents = range.cloneContents();
          const otherSpans = contents.querySelectorAll('.seg-other');
          if (otherSpans.length > 0) {
            e.preventDefault();
            showToast("Can't delete other users' text", true);
            return;
          }
        } else {
          // Single char delete — check if it would affect an other-user span
          const node = sel.anchorNode;
          const container = node.nodeType === 3 ? node.parentElement : node;
          if (container && container.classList && container.classList.contains('seg-other')) {
            e.preventDefault();
            return;
          }
          // Check if backspace at start of gap would eat into previous other-user span
          if (e.inputType === 'deleteContentBackward' && sel.anchorOffset === 0) {
            const prev = container.previousSibling;
            if (prev && prev.classList && prev.classList.contains('seg-other')) {
              e.preventDefault();
              return;
            }
          }
          // Check if forward delete at end would eat into next other-user span
          if (e.inputType === 'deleteContentForward') {
            const atEnd = node.nodeType === 3 ? sel.anchorOffset >= node.textContent.length : true;
            if (atEnd) {
              const next = container.nextSibling;
              if (next && next.classList && next.classList.contains('seg-other')) {
                e.preventDefault();
                return;
              }
            }
          }
        }
      }

      // Block drag-drop
      if (e.inputType === 'insertFromDrop' || e.inputType === 'deleteByDrag') {
        e.preventDefault();
        return;
      }

      // Handle paste as plain text
      if (e.inputType === 'insertFromPaste') {
        e.preventDefault();
        const text = e.dataTransfer ? e.dataTransfer.getData('text/plain') : '';
        if (text) {
          insertTextAtCursor(editor, text);
        }
        return;
      }

      // For regular typing, ensure we're inside a user-owned span
      if (e.inputType === 'insertText' || e.inputType === 'insertCompositionText') {
        const node = sel.anchorNode;
        const container = node.nodeType === 3 ? node.parentElement : node;
        if (container && container.classList && container.classList.contains('seg-other')) {
          e.preventDefault();
          return;
        }
        // If typing directly into the editor div (not in a span), wrap in a span
        if (container === editor) {
          e.preventDefault();
          if (e.data) {
            insertTextAtCursor(editor, e.data);
          }
          return;
        }
        // Ensure the span we're in is marked as ours
        if (container.classList && (container.classList.contains('seg-gap') || container.classList.contains('seg-mine'))) {
          container.dataset.userId = currentUser.userId;
          container.style.color = currentUser.color;
          container.classList.remove('seg-gap');
          container.classList.add('seg', 'seg-mine');
        }
      }
    });

    // Handle Enter key — insert newline rather than div
    editor.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        insertTextAtCursor(editor, '\n');
      }
    });

    // Track focus
    editor.addEventListener('focus', () => {
      focusedField = editor.dataset.field;
    });

    editor.addEventListener('blur', () => {
      if (focusedField === editor.dataset.field) {
        focusedField = null;
      }
      // Store local state
      const segs = getEditorSegments(editor);
      localEdits[editor.dataset.field] = segs;
    });

    // MutationObserver safety net
    const observer = new MutationObserver((mutations) => {
      // Check if any other-user span was mutated
      for (const m of mutations) {
        if (m.target.classList && m.target.classList.contains('seg-other')) {
          // Revert: re-render from server data
          const fieldId = editor.dataset.field;
          const segments = localEdits[fieldId] || serverData.fields[fieldId] || [];
          renderEditor(editor, segments, true);
          return;
        }
      }
    });
    observer.observe(editor, { childList: true, subtree: true, characterData: true });
  }

  function insertTextAtCursor(editor, text) {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;

    const range = sel.getRangeAt(0);
    range.deleteContents();

    const node = sel.anchorNode;
    let container = node.nodeType === 3 ? node.parentElement : node;

    // If we're at the editor level, find or create a span
    if (container === editor) {
      const span = document.createElement('span');
      span.className = 'seg seg-mine';
      span.dataset.userId = currentUser.userId;
      span.style.color = currentUser.color;
      span.textContent = text;
      range.insertNode(span);
      // Place cursor at end of span
      const newRange = document.createRange();
      newRange.setStartAfter(span.lastChild || span);
      newRange.collapse(true);
      sel.removeAllRanges();
      sel.addRange(newRange);
      return;
    }

    // If in a gap or own span, just insert text
    if (container.classList && (container.classList.contains('seg-gap') || container.classList.contains('seg-mine'))) {
      container.dataset.userId = currentUser.userId;
      container.style.color = currentUser.color;
      container.classList.remove('seg-gap');
      container.classList.add('seg', 'seg-mine');
      const textNode = document.createTextNode(text);
      range.insertNode(textNode);
      const newRange = document.createRange();
      newRange.setStartAfter(textNode);
      newRange.collapse(true);
      sel.removeAllRanges();
      sel.addRange(newRange);
    }
  }

  // === Save ===
  async function saveAllFields() {
    if (!currentUser) {
      showToast('Please register first', true);
      return;
    }

    // Collect current state from all editors
    const editors = document.querySelectorAll('.collab-editor');
    let errors = 0;
    let saved = 0;

    for (const editor of editors) {
      const fieldId = editor.dataset.field;
      const segments = getEditorSegments(editor);

      // Skip empty fields that were already empty on server
      const serverSegs = serverData.fields[fieldId] || [];
      if (segments.length === 0 && serverSegs.length === 0) continue;

      // Skip if nothing changed
      if (JSON.stringify(segments) === JSON.stringify(serverSegs)) continue;

      try {
        const resp = await fetch('/api/save', {
          method: 'POST',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ userId: currentUser.userId, fieldId, segments }),
        });

        if (resp.ok) {
          const result = await resp.json();
          serverData.fields[fieldId] = segments;
          serverData.version = result.version;
          saved++;
        } else {
          const err = await resp.json();
          console.error(`Save error for ${fieldId}:`, err.error);
          errors++;
        }
      } catch (e) {
        errors++;
      }
    }

    if (errors > 0) {
      showToast(`Saved with ${errors} error(s) — some fields may have conflicts`, true);
    } else if (saved > 0) {
      showToast('Progress saved!');
    } else {
      showToast('No changes to save');
    }
  }
  // Expose globally for the onclick handler
  window.saveAllFields = saveAllFields;

  // === Export ===
  function exportData() {
    // Export as flat text for simplicity
    const out = {};
    const editors = document.querySelectorAll('.collab-editor');
    editors.forEach(ed => {
      const segs = getEditorSegments(ed);
      out[ed.dataset.field] = segs.map(s => s.text).join('');
    });
    const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'story_planner.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Exported as JSON!');
  }
  window.exportData = exportData;

  // === Sync / Polling ===
  async function fetchFullData() {
    try {
      const resp = await fetch('/api/data', { headers: authHeaders() });
      if (!resp.ok) return;
      serverData = await resp.json();
      renderUserPanel();
      renderAllEditors();
      updateSyncDot(true);
    } catch (e) {
      updateSyncDot(false);
    }
  }

  async function pollVersion() {
    try {
      const resp = await fetch('/api/version', { headers: authHeaders() });
      if (!resp.ok) return;
      const { version } = await resp.json();
      if (version !== serverData.version) {
        await fetchFullData();
      }
      updateSyncDot(true);
    } catch (e) {
      updateSyncDot(false);
    }
  }

  function updateSyncDot(connected) {
    const dot = document.getElementById('syncDot');
    const label = document.getElementById('syncLabel');
    if (connected) {
      dot.className = 'sync-dot';
      label.textContent = 'Connected';
    } else {
      dot.className = 'sync-dot stale';
      label.textContent = 'Offline';
    }
  }

  function renderAllEditors() {
    const editors = document.querySelectorAll('.collab-editor');
    editors.forEach(editor => {
      const fieldId = editor.dataset.field;
      const segments = serverData.fields[fieldId] || [];
      renderEditor(editor, segments, false);
    });
  }

  // === Start App ===
  function startApp() {
    // Setup all editors
    const editors = document.querySelectorAll('.collab-editor');
    editors.forEach(ed => setupEditor(ed));

    // Initial data load
    fetchFullData();

    // Poll every 5 seconds
    pollTimer = setInterval(pollVersion, 5000);
  }

  // === Init ===
  initPasswordGate();
})();
</script>

</body>
</html>
